// Danish alphabet data with words and emojis
const danishAlphabet = [
    { letter: 'A', words: [{ text: 'Abe', emoji: 'ðŸµ' }, { text: 'Avis', emoji: 'ðŸ“°' }] },
    { letter: 'B', words: [{ text: 'BjÃ¸rn', emoji: 'ðŸ»' }, { text: 'BrÃ¸d', emoji: 'ðŸž' }] },
    { letter: 'C', words: [{ text: 'Cikade', emoji: 'ðŸ¦—' }, { text: 'Cykel', emoji: 'ðŸš²' }] },
    { letter: 'D', words: [{ text: 'Delfin', emoji: 'ðŸ¬' }, { text: 'DÃ¸r', emoji: 'ðŸšª' }] },
    { letter: 'E', words: [{ text: 'Egern', emoji: 'ðŸ¿ï¸' }, { text: 'Elev', emoji: 'ðŸ‘¨â€ðŸŽ“' }] },
    { letter: 'F', words: [{ text: 'Fisk', emoji: 'ðŸŸ' }, { text: 'Fod', emoji: 'ðŸ¦¶' }] },
    { letter: 'G', words: [{ text: 'Giraf', emoji: 'ðŸ¦’' }, { text: 'Glas', emoji: 'ðŸ¥ƒ' }] },
    { letter: 'H', words: [{ text: 'Hund', emoji: 'ðŸ•' }, { text: 'Hus', emoji: 'ðŸ ' }] },
    { letter: 'I', words: [{ text: 'Ildflue', emoji: 'ðŸª²' }, { text: 'Is', emoji: 'ðŸ¦' }] },
    { letter: 'J', words: [{ text: 'Jaguar', emoji: 'ðŸ†' }, { text: 'Jakke', emoji: 'ðŸ§¥' }] },
    { letter: 'K', words: [{ text: 'Kat', emoji: 'ðŸˆ' }, { text: 'Kaffe', emoji: 'â˜•' }] },
    { letter: 'L', words: [{ text: 'LÃ¸ve', emoji: 'ðŸ¦' }, { text: 'Lampe', emoji: 'ðŸ’¡' }] },
    { letter: 'M', words: [{ text: 'Mus', emoji: 'ðŸ­' }, { text: 'MÃ¦lk', emoji: 'ðŸ¥›' }] },
    { letter: 'N', words: [{ text: 'NÃ¦sehorn', emoji: 'ðŸ¦' }, { text: 'NÃ¸gle', emoji: 'ðŸ”‘' }] },
    { letter: 'O', words: [{ text: 'Ã˜rn', emoji: 'ðŸ¦…' }, { text: 'Oste', emoji: 'ðŸ§€' }] },
    { letter: 'P', words: [{ text: 'Pingvin', emoji: 'ðŸ§' }, { text: 'Penge', emoji: 'ðŸ’°' }] },
    { letter: 'Q', words: [{ text: 'Quokka', emoji: 'ðŸ¦˜' }, { text: 'Quiz', emoji: 'â“' }] },
    { letter: 'R', words: [{ text: 'RÃ¦v', emoji: 'ðŸ¦Š' }, { text: 'Regn', emoji: 'ðŸŒ§ï¸' }] },
    { letter: 'S', words: [{ text: 'Slange', emoji: 'ðŸ' }, { text: 'Sko', emoji: 'ðŸ‘Ÿ' }] },
    { letter: 'T', words: [{ text: 'Tiger', emoji: 'ðŸ¯' }, { text: 'Tog', emoji: 'ðŸš‚' }] },
    { letter: 'U', words: [{ text: 'Ugle', emoji: 'ðŸ¦‰' }, { text: 'Ur', emoji: 'â°' }] },
    { letter: 'V', words: [{ text: 'Vildsvin', emoji: 'ðŸ—' }, { text: 'Vand', emoji: 'ðŸ’§' }] },
    { letter: 'W', words: [{ text: 'Wombat', emoji: 'ðŸ¦«' }, { text: 'Weekend', emoji: 'ðŸ–ï¸' }] },
    { letter: 'X', words: [{ text: 'Xerus', emoji: 'ðŸ¿ï¸' }, { text: 'Xylofon', emoji: 'ðŸŽµ' }] },
    { letter: 'Y', words: [{ text: 'Yak', emoji: 'ðŸƒ' }, { text: 'Yoghurt', emoji: 'ðŸ¥£' }] },
    { letter: 'Z', words: [{ text: 'Zebra', emoji: 'ðŸ¦“' }, { text: 'Zone', emoji: 'ðŸ—ºï¸' }] },
    { letter: 'Ã†', words: [{ text: 'Ã†sel', emoji: 'ðŸ«' }, { text: 'Ã†ble', emoji: 'ðŸŽ' }] },
    { letter: 'Ã˜', words: [{ text: 'Ã˜rred', emoji: 'ðŸŸ' }, { text: 'Ã˜l', emoji: 'ðŸº' }] },
    { letter: 'Ã…', words: [{ text: 'Ã…l', emoji: 'ðŸ' }, { text: 'Ã…ben', emoji: 'ðŸ”“' }] }
];

// Danish colors data
const danishColors = [
    { name: 'RÃ¸d', color: '#FF0000', emoji: 'â¤ï¸' },
    { name: 'BlÃ¥', color: '#0000FF', emoji: 'ðŸ’™' },
    { name: 'Gul', color: '#FFFF00', emoji: 'ðŸ’›' },
    { name: 'GrÃ¸n', color: '#00FF00', emoji: 'ðŸ’š' },
    { name: 'Orange', color: '#FF8800', emoji: 'ðŸ§¡' },
    { name: 'Lilla', color: '#800080', emoji: 'ðŸ’œ' },
    { name: 'Pink', color: '#FFC0CB', emoji: 'ðŸ©·' },
    { name: 'Brun', color: '#8B4513', emoji: 'ðŸ¤Ž' },
    { name: 'Sort', color: '#000000', emoji: 'ðŸ–¤' },
    { name: 'Hvid', color: '#FFFFFF', emoji: 'ðŸ¤' },
    { name: 'GrÃ¥', color: '#808080', emoji: 'ðŸ©¶' },
    { name: 'Turkis', color: '#40E0D0', emoji: 'ðŸ’Ž' }
];

// Track which cards have been clicked
const clickedCards = new Set();

// Initialize the app
function init() {
    // Initialize alphabet game
    const alphabetGrid = document.getElementById('alphabetGrid');
    danishAlphabet.forEach((item, index) => {
        const card = createLetterCard(item, index);
        alphabetGrid.appendChild(card);
    });

    // Initialize colors game
    const colorsGrid = document.getElementById('colorsGrid');
    danishColors.forEach((item, index) => {
        const card = createColorCard(item, index);
        colorsGrid.appendChild(card);
    });

    // Setup navigation
    setupNavigation();

    // Setup color game
    setupColorGame();
}

// Color Game State
let currentColorQuestion = null;
let isGameActive = false;

// Setup Color Game
function setupColorGame() {
    const startBtn = document.getElementById('startColorGameBtn');
    const exitBtn = document.getElementById('exitGameBtn');

    startBtn.addEventListener('click', startColorGame);
    exitBtn.addEventListener('click', exitColorGame);
}

// Start Color Game
function startColorGame() {
    isGameActive = true;

    // Hide free play mode
    document.getElementById('colorsFreePlay').style.display = 'none';
    document.getElementById('colorsQuizMode').style.display = 'block';

    // Start countdown
    startCountdown();
}

// Exit Color Game
function exitColorGame() {
    isGameActive = false;

    // Show free play mode
    document.getElementById('colorsFreePlay').style.display = 'block';
    document.getElementById('colorsQuizMode').style.display = 'none';
    document.getElementById('quizInterface').style.display = 'none';
}

// Countdown: 3, 2, 1, Go!
function startCountdown() {
    const countdown = document.getElementById('countdown');
    const countdownNumber = countdown.querySelector('.countdown-number');

    countdown.style.display = 'flex';

    const sequence = ['3', '2', '1', 'Go!'];
    let index = 0;

    function showNext() {
        if (index < sequence.length) {
            countdownNumber.textContent = sequence[index];
            countdownNumber.style.animation = 'none';
            setTimeout(() => {
                countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
            }, 10);

            // Speak the countdown
            if (sequence[index] === 'Go!') {
                speakText('Go');
            } else {
                speakText(sequence[index]);
            }

            index++;
            setTimeout(showNext, 1000);
        } else {
            countdown.style.display = 'none';
            startQuizRound();
        }
    }

    showNext();
}

// Start a quiz round
function startQuizRound() {
    document.getElementById('quizInterface').style.display = 'block';

    // Pick a random color as the correct answer
    currentColorQuestion = danishColors[Math.floor(Math.random() * danishColors.length)];

    // Display the color name
    const colorNameEl = document.getElementById('quizColorName');
    colorNameEl.textContent = currentColorQuestion.name;

    // Speak the color name
    setTimeout(() => {
        speakText(currentColorQuestion.name);
    }, 300);

    // Generate 4 options (including correct answer)
    const options = generateColorOptions(currentColorQuestion);

    // Display options
    displayColorOptions(options);
}

// Generate 4 color options
function generateColorOptions(correctColor) {
    const options = [correctColor];

    // Add 3 random different colors
    while (options.length < 4) {
        const randomColor = danishColors[Math.floor(Math.random() * danishColors.length)];
        if (!options.includes(randomColor)) {
            options.push(randomColor);
        }
    }

    // Shuffle options
    return options.sort(() => Math.random() - 0.5);
}

// Display color options in 2x2 grid
function displayColorOptions(options) {
    const container = document.getElementById('quizOptions');
    container.innerHTML = '';

    options.forEach(option => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'quiz-option';
        optionDiv.style.backgroundColor = option.color;

        // Add border for white color
        if (option.name === 'Hvid') {
            optionDiv.style.border = '6px solid #ddd';
        }

        // Add emoji
        const emoji = document.createElement('span');
        emoji.textContent = option.emoji;
        optionDiv.appendChild(emoji);

        // Click handler
        optionDiv.addEventListener('click', () => handleColorSelection(optionDiv, option));

        container.appendChild(optionDiv);
    });
}

// Handle color selection
function handleColorSelection(element, selectedColor) {
    // Prevent multiple clicks
    const allOptions = document.querySelectorAll('.quiz-option');
    allOptions.forEach(opt => opt.style.pointerEvents = 'none');

    if (selectedColor.name === currentColorQuestion.name) {
        // Correct answer
        element.classList.add('correct');
        showFeedback('ðŸ‘', '#4CAF50');

        // Wait then start new round
        setTimeout(() => {
            if (isGameActive) {
                startQuizRound();
            }
        }, 2000);
    } else {
        // Incorrect answer
        element.classList.add('incorrect');

        // Find and highlight correct answer
        allOptions.forEach(opt => {
            const optColor = opt.style.backgroundColor;
            if (rgbToHex(optColor) === currentColorQuestion.color.toUpperCase()) {
                setTimeout(() => {
                    opt.classList.add('correct');
                }, 300);
            }
        });

        showFeedback('ðŸ‘Ž', '#f44336');

        // Say the correct color again
        setTimeout(() => {
            speakText(currentColorQuestion.name);
        }, 800);

        // Wait then start new round
        setTimeout(() => {
            if (isGameActive) {
                startQuizRound();
            }
        }, 3000);
    }
}

// Show feedback overlay
function showFeedback(icon, color) {
    const overlay = document.getElementById('feedbackOverlay');
    const iconEl = overlay.querySelector('.feedback-icon');

    iconEl.textContent = icon;
    iconEl.style.color = color;
    overlay.style.display = 'block';

    iconEl.style.animation = 'none';
    setTimeout(() => {
        iconEl.style.animation = 'feedbackPop 0.8s ease';
    }, 10);

    setTimeout(() => {
        overlay.style.display = 'none';
    }, 800);
}

// Convert RGB to Hex
function rgbToHex(rgb) {
    const values = rgb.match(/\d+/g);
    if (!values) return rgb;

    const r = parseInt(values[0]).toString(16).padStart(2, '0');
    const g = parseInt(values[1]).toString(16).padStart(2, '0');
    const b = parseInt(values[2]).toString(16).padStart(2, '0');

    return `#${r}${g}${b}`.toUpperCase();
}

// Setup navigation between games
function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    const gameTitle = document.getElementById('gameTitle');
    const gameSubtitle = document.getElementById('gameSubtitle');

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const gameName = item.dataset.game;

            // Update active nav item
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');

            // Hide all games
            document.querySelectorAll('.game-content').forEach(game => {
                game.classList.remove('active');
            });

            // Show selected game
            if (gameName === 'alphabet') {
                document.getElementById('alphabetGame').classList.add('active');
                gameTitle.textContent = 'ðŸ”¤ Alfabet';
                gameSubtitle.textContent = 'Tryk pÃ¥ kortet for at lÃ¦re!';
            } else if (gameName === 'colors') {
                document.getElementById('colorsGame').classList.add('active');
                gameTitle.textContent = 'ðŸŽ¨ Farver';
                gameSubtitle.textContent = 'Tryk pÃ¥ farven for at lÃ¦re!';
            }
        });
    });
}

// Create a letter card
function createLetterCard(item, index) {
    const card = document.createElement('div');
    card.className = 'letter-card';
    card.dataset.index = index;

    // Letter display
    const letterDisplay = document.createElement('div');
    letterDisplay.className = 'letter-display';
    letterDisplay.innerHTML = `<h2>${item.letter}</h2>`;

    // Words section (hidden initially)
    const wordsSection = document.createElement('div');
    wordsSection.className = 'words-section';

    item.words.forEach(word => {
        const wordItem = document.createElement('div');
        wordItem.className = 'word-item';

        // Create emoji element
        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'word-emoji';
        emojiSpan.textContent = word.emoji;

        // Create text element
        const text = document.createElement('h3');
        text.textContent = word.text;

        wordItem.appendChild(emojiSpan);
        wordItem.appendChild(text);

        wordItem.addEventListener('click', (e) => {
            e.stopPropagation();
            speakText(word.text);
            animateCard(wordItem, 'spin');
        });
        wordsSection.appendChild(wordItem);
    });

    card.appendChild(letterDisplay);
    card.appendChild(wordsSection);

    // Card click handler
    card.addEventListener('click', () => handleCardClick(card, item, wordsSection));

    return card;
}

// Handle card click
function handleCardClick(card, item, wordsSection) {
    const cardIndex = card.dataset.index;

    // Animate the card
    animateCard(card, 'spin');

    // First click: pronounce letter
    if (!clickedCards.has(cardIndex)) {
        speakText(item.letter, true); // true indicates it's a letter
        clickedCards.add(cardIndex);

        // Show words after pronunciation
        setTimeout(() => {
            wordsSection.classList.add('show');
        }, 600);
    } else {
        // Subsequent clicks: just pronounce letter
        speakText(item.letter, true); // true indicates it's a letter
    }
}

// Animate card
function animateCard(element, animationClass) {
    element.classList.add(animationClass);
    setTimeout(() => {
        element.classList.remove(animationClass);
    }, 600);
}

// Create a color card
function createColorCard(item, index) {
    const card = document.createElement('div');
    card.className = 'color-card';
    card.dataset.index = index;

    // Color display box
    const colorDisplay = document.createElement('div');
    colorDisplay.className = 'color-display';
    colorDisplay.style.backgroundColor = item.color;

    // Add border for white color visibility
    if (item.name === 'Hvid') {
        colorDisplay.style.border = '3px solid #ddd';
    }

    // Add emoji to color display
    const emojiSpan = document.createElement('span');
    emojiSpan.textContent = item.emoji;
    colorDisplay.appendChild(emojiSpan);

    // Color name
    const colorName = document.createElement('h2');
    colorName.className = 'color-name';
    colorName.textContent = item.name;

    card.appendChild(colorDisplay);
    card.appendChild(colorName);

    // Card click handler
    card.addEventListener('click', () => {
        animateCard(card, 'spin');
        speakText(item.name);
    });

    return card;
}

// Text-to-speech function
function speakText(text, isLetter = false) {
    // Cancel any ongoing speech
    window.speechSynthesis.cancel();

    // For single letters, we need to use SSML or phonetic approach
    // Danish letters pronunciation mapping
    const letterPronunciation = {
        'A': 'a',
        'B': 'be',
        'C': 'se',
        'D': 'de',
        'E': 'e',
        'F': 'Ã¦f',
        'G': 'ge',
        'H': 'hÃ¥',
        'I': 'i',
        'J': 'jÃ¥d',
        'K': 'kÃ¥',
        'L': 'Ã¦l',
        'M': 'Ã¦m',
        'N': 'Ã¦n',
        'O': 'o',
        'P': 'pe',
        'Q': 'ku',
        'R': 'Ã¦r',
        'S': 'Ã¦s',
        'T': 'te',
        'U': 'u',
        'V': 've',
        'W': 'dobbelt ve',
        'X': 'Ã¦ks',
        'Y': 'y',
        'Z': 'sÃ¦t',
        'Ã†': 'Ã¦',
        'Ã˜': 'Ã¸',
        'Ã…': 'Ã¥'
    };

    // If it's a single letter, use the pronunciation guide
    const textToSpeak = isLetter && letterPronunciation[text]
        ? letterPronunciation[text]
        : text;

    const utterance = new SpeechSynthesisUtterance(textToSpeak);
    utterance.lang = 'da-DK'; // Danish language
    utterance.rate = 0.7; // Slower for toddlers
    utterance.pitch = 1.2; // Higher pitch for toddlers
    utterance.volume = 1.0;

    // Try to find a Danish voice
    const voices = window.speechSynthesis.getVoices();
    const danishVoice = voices.find(voice => voice.lang.startsWith('da'));

    if (danishVoice) {
        utterance.voice = danishVoice;
    }

    window.speechSynthesis.speak(utterance);
}

// Load voices (some browsers need this)
window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
};

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', init);
